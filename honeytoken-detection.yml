name: Honeytoken Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  scan-for-tokens:
    name: Scan Repository for Leaked Tokens
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run honeytoken scanner
        id: scan
        run: |
          python ci_scanner.py \
            --scan-workspace \
            --format github \
            --output-file scan-report.md
        continue-on-error: true
      
      - name: Get scan results
        id: results
        run: |
          if [ -f scan_results.json ]; then
            findings=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['scans'][-1]['total_findings'] if data['scans'] else 0)")
            honeytokens=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['scans'][-1]['honeytokens_found'] if data['scans'] else 0)")
            echo "findings=$findings" >> $GITHUB_OUTPUT
            echo "honeytokens=$honeytokens" >> $GITHUB_OUTPUT
          else
            echo "findings=0" >> $GITHUB_OUTPUT
            echo "honeytokens=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-report
          path: |
            scan-report.md
            scan_results.json
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.results.outputs.findings > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'No report generated';
            
            try {
              report = fs.readFileSync('scan-report.md', 'utf8');
            } catch (error) {
              report = 'âŒ Error reading scan report';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” Honeytoken Scan Results\n\n${report}`
            });
      
      - name: Create issue for honeytokens
        if: steps.results.outputs.honeytokens > 0
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Honeytoken Detected in Repository',
              body: `## Security Alert: Honeytoken Detection
              
              **Honeytokens Found:** ${{ steps.results.outputs.honeytokens }}
              **Total Findings:** ${{ steps.results.outputs.findings }}
              
              ### What This Means
              
              A honeytoken is a deliberately planted credential designed to detect unauthorized access or data leaks. The presence of a honeytoken in this repository indicates:
              
              1. Someone may have committed test/example credentials
              2. A security monitoring token was accidentally included
              3. Credentials from another source were copied
              
              ### Immediate Actions Required
              
              1. âœ… Review the scan report artifact
              2. âœ… Identify the source of the leaked token
              3. âœ… Remove the token from the repository
              4. âœ… Update git history if necessary
              5. âœ… Rotate any potentially compromised credentials
              
              ### Scan Details
              
              - **Workflow Run:** ${{ github.run_id }}
              - **Triggered by:** ${{ github.actor }}
              - **Branch:** ${{ github.ref_name }}
              - **Commit:** ${{ github.sha }}
              
              See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed results.
              `,
              labels: ['security', 'honeytoken', 'critical']
            });
      
      - name: Fail on honeytoken detection
        if: steps.results.outputs.honeytokens > 0
        run: |
          echo "::error::Honeytokens detected in repository!"
          echo "::error::Found ${{ steps.results.outputs.honeytokens }} honeytoken(s)"
          exit 1
  
  scan-diff:
    name: Scan Changed Files (PR Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Scan changed files
        id: diff-scan
        run: |
          python ci_scanner.py \
            --scan-diff \
            --base-ref origin/${{ github.base_ref }} \
            --head-ref ${{ github.sha }} \
            --format markdown \
            --output-file diff-report.md
        continue-on-error: true
      
      - name: Upload diff scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diff-scan-report
          path: diff-report.md
  
  test-suite:
    name: Run Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: python test_suite.py
      
      - name: Test webhook server
        run: |
          # Start webhook server in background
          python webhook_server.py --port 8080 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Test health endpoint
          curl -f http://localhost:8080/health || exit 1
          
          # Stop server
          kill $SERVER_PID
